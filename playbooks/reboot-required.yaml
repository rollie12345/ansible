---
- name: Check if servers require a reboot
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Check for reboot-required file (Debian/Ubuntu)
      stat:
        path: /var/run/reboot-required
      register: debian_reboot
      when: ansible_os_family == "Debian"

    - name: Check if reboot is needed (RedHat/CentOS)
      command: needs-restarting -r
      register: redhat_reboot
      failed_when: false
      changed_when: false
      when: ansible_os_family == "RedHat"

    - name: Check if reboot is pending (Windows)
      win_reg_stat:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired
      register: win_reboot
      when: ansible_os_family == "Windows"

    - name: Determine Reboot Status
      set_fact:
        needs_reboot: >-
          {% if ansible_os_family == "Debian" and debian_reboot.stat.exists %}Yes
          {% elif ansible_os_family == "RedHat" and redhat_reboot.rc == 1 %}Yes
          {% elif ansible_os_family == "Windows" and win_reboot.exists %}Yes
          {% else %}No{% endif %}

    - name: Send Reboot Status to Discord
      delegate_to: localhost
      become: false
      uri:
        # Use the variable here
        url: "{{ discord_webhook_url_reboot_status }}"
        method: POST
        body_format: json
        status_code: [200, 204]
        headers:
          User-Agent: "Ansible/2.x"
        body:
          username: "Update Monitor"
          embeds:
            - title: "System Reboot Report"
              color: "{{ (needs_reboot | trim == 'Yes') | ternary(15158332, 3066993) }}"
              fields:
                - name: "Real Hostname"
                  value: "{{ ansible_hostname }}"
                  inline: true
                - name: "Actual IP Address"
                  value: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) | default('Unknown') }}"
                  inline: true
                - name: "OS Family"
                  value: "{{ ansible_os_family }}"
                  inline: true
                - name: "Reboot Required?"
                  value: "**{{ needs_reboot | trim }}**"
                  inline: false
      ignore_errors: true