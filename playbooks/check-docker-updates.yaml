---
- name: Check Docker Updates
  hosts: all
  vars:
    discord_webhook_url: "{{ discord_webhook_url_docker_updates }}"
  tasks:
    - name: Get info about all containers
      community.docker.docker_host_info:
        containers: yes
      register: host_info

    - name: Check for newer images (dry-run)
      community.docker.docker_image:
        name: "{{ item.Image }}"
        source: pull
      check_mode: yes
      register: pull_results
      loop: "{{ host_info.containers }}"
      loop_control:
        label: "{{ item.Names[0] }}"
      ignore_errors: yes

    - name: Build list of updateable containers
      set_fact:
        updates: "{{ updates | default([]) + [item.item.Names[0] | regex_replace('^/', '')] }}"
      when: item.changed
      loop: "{{ pull_results.results }}"
      loop_control:
        label: "{{ item.item.Names[0] }}"

    - name: Send Discord Notification
      community.general.discord:
        webhook_id: "{{ discord_webhook_url_docker_updates.split('/')[-2] }}"
        webhook_token: "{{ discord_webhook_url_docker_updates.split('/')[-1] }}"
        embeds:
          - title: "ðŸ“¦ Docker Update Available"
            description: "New images found for the following containers in your LXC:"
            color: 3066993
            fields:
              - name: "Containers"
                value: "{{ updates | join('\n') }}"
      when: updates is defined and updates | length > 0