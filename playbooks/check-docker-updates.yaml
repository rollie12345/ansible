---
- name: Check Docker Updates
  hosts: all
  vars:
    webhook_url: "{{ discord_webhook_url_docker_updates }}"
  tasks:
    - name: Get info about all containers
      community.docker.docker_host_info:
        containers: yes
      register: host_info

    - name: Check for newer images (dry-run)
      community.docker.docker_image:
        name: "{{ item.Image }}"
        source: pull
      check_mode: yes
      register: pull_results
      loop: "{{ host_info.containers }}"
      loop_control:
        label: "{{ item.Names[0] }}"
      ignore_errors: yes

    - name: Build list of updateable containers
      set_fact:
        updates: "{{ updates | default([]) + [item.item.Names[0] | regex_replace('^/', '')] }}"
      when: item.changed
      loop: "{{ pull_results.results }}"
      loop_control:
        label: "{{ item.item.Names[0] }}"

    - name: Send Discord Status Report
      community.general.discord:
        webhook_id: "{{ webhook_url.split('/')[-2] }}"
        webhook_token: "{{ webhook_url.split('/')[-1] }}"
        embeds:
          - title: "üê≥ Docker Update Report"
            # Logic: Change color to Red if updates exist, Green if not.
            color: "{{ (updates | default([]) | length > 0) | ternary(15158332, 3066993) }}"
            description: "Update check completed for host: **{{ inventory_hostname }}**"
            fields:
              - name: "Status"
                value: >
                  {% if updates is defined and updates | length > 0 %}
                  ‚ö†Ô∏è Updates found for:
                  {{ updates | join('\n') }}
                  {% else %}
                  ‚úÖ All containers are up to date!
                  {% endif %}
      # Note: 'when' condition is removed so it ALWAYS sends.