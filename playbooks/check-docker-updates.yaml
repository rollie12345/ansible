---
- name: Check Docker Updates with Version Proof
  hosts: all
  vars:
    webhook_url: "{{ discord_webhook_url_docker_updates }}"
  tasks:
    - name: Get info about all containers
      community.docker.docker_host_info:
        containers: yes
      register: host_info

    - name: Check for newer images (dry-run)
      community.docker.docker_image:
        name: "{{ item.Image }}"
        source: pull
      check_mode: yes
      register: pull_results
      loop: "{{ host_info.containers }}"
      loop_control:
        label: "{{ item.Names[0] }}"
      ignore_errors: yes

    - name: Map container details
      set_fact:
        # We store the name and a short version of the SHA hash for the report
        container_report: >-
          {{
            container_report | default([]) + [{
              'name': item.item.Names[0] | regex_replace('^/', ''),
              'image': item.item.Image,
              'local_sha': item.image.Id[:12] if item.image.Id is defined else 'Unknown',
              'remote_sha': item.actions[0].split(' ')[-1][:12] if item.changed and item.actions is defined else 'Up to date',
              'status': 'ðŸ”„ UPDATE AVAILABLE' if item.changed else 'âœ… LATEST'
            }]
          }}
      loop: "{{ pull_results.results }}"
      loop_control:
        label: "{{ item.item.Names[0] }}"

    - name: Send Detailed Discord Report
      community.general.discord:
        webhook_id: "{{ webhook_url.split('/')[-2] }}"
        webhook_token: "{{ webhook_url.split('/')[-1] }}"
        embeds:
          - title: "ðŸ³ Docker Version Audit"
            color: "{{ (pull_results.results | selectattr('changed') | list | length > 0) | ternary(15158332, 3066993) }}"
            description: "Comparing local container layers vs. Remote Registry"
            fields:
              - name: "Container Analysis"
                value: |
                  {% for c in container_report %}
                  **{{ c.name }}** ({{ c.image }})
                  Status: `{{ c.status }}`
                  Local: `{{ c.local_sha }}` | Remote: `{{ c.remote_sha }}`
                  {% endfor %}