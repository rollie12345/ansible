---
- name: Check Docker Updates
  hosts: all
  vars:
    # You can also pass these via Semaphore "Environment" variables
    discord_webhook_url: "{{ discord_webhook_url_docker_updates}}"
  tasks:
    - name: Get running container info
      community.docker.docker_container_info:
      register: docker_info

    - name: Check for newer images (dry-run)
      community.docker.docker_image:
        name: "{{ item.Config.Image }}"
        source: pull
      check_mode: yes
      register: pull_results
      loop: "{{ docker_info.containers }}"
      loop_control:
        label: "{{ item.Name }}"
      ignore_errors: yes

    - name: Build list of updateable containers
      set_fact:
        updates: "{{ updates | default([]) + [item.item.Name | regex_replace('^/', '')] }}"
      when: item.changed
      loop: "{{ pull_results.results }}"
      loop_control:
        label: "{{ item.item.Name }}"

    - name: Send Discord Notification
      community.general.discord:
        webhook_id: "{{ discord_webhook_url.split('/')[-2] }}"
        webhook_token: "{{ discord_webhook_url.split('/')[-1] }}"
        embeds:
          - title: "ðŸ“¦ Update Available"
            description: "New images found for the following containers:"
            color: 3066993
            fields:
              - name: "Containers"
                value: "{{ updates | join('\n') }}"
      when: updates is defined and updates | length > 0