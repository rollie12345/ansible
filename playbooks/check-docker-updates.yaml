---
- name: Check Docker Updates with Version Proof
  hosts: all
  vars:
    webhook_url: "{{ discord_webhook_url_docker_updates }}"
  tasks:
    - name: Get info about all containers
      community.docker.docker_host_info:
        containers: yes
      register: host_info

    - name: Check for newer images (dry-run)
      community.docker.docker_image:
        name: "{{ item.Image }}"
        source: pull
      check_mode: yes
      register: pull_results
      loop: "{{ host_info.containers }}"
      loop_control:
        label: "{{ item.Names[0] }}"
      ignore_errors: yes

    - name: Build Report String
      set_fact:
        report_body: |
          {% for item in pull_results.results %}
          **{{ item.item.Names[0] | regex_replace('^/', '') }}**
          `{{ 'ðŸ”„ Update' if item.changed else 'âœ… Latest' }}` (L: {{ item.image.Id[:7] if item.image.Id is defined else '???' }} | R: {{ item.actions[0].split(' ')[-1][:7] if item.changed else 'Same' }})
          {% endfor %}

    - name: Send Detailed Discord Report
      community.general.discord:
        webhook_id: "{{ webhook_url.split('/')[-2] }}"
        webhook_token: "{{ webhook_url.split('/')[-1] }}"
        embeds:
          - title: "ðŸ³ Docker Update Audit"
            color: 3066993
            description: "{{ report_body }}"
            footer:
              text: "Host: {{ inventory_hostname }}"
      # Only attempt if we actually have a report body to send
      when: report_body | trim | length > 0